---
title: "knn"
author: "Yang Meng"
date: "11/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#simulated data Q
set.seed(1)
K = 5
M = 8
Q = matrix(rnorm(K*M), nrow = K, ncol = M)
Q
```

```{r}
#distance
simi <- function(Q){
  mag_fron = apply(Q, 2, function(q)return(sqrt(sum(q^2))))
  return( (t(Q)%*%Q) / (mag_fron%*%t(mag_fron)) )
}
simi(Q)
#knn
svd_knn <- function(NN, i, k){
  return(order(NN[,i], decreasing = T)[2:(1+k)])
}
svd_knn(simi(Q), 3, 3)
```

```{r}
setwd('/Users/mengyang/Documents/GitHub/fall2019-project4-sec2-grp7/doc')
load('../output/mat_fac.RData')
ratings = read.csv('../data/ml-latest-small/ratings.csv')
```

```{r}
#distance
simi <- function(Q){
  mag_fron = apply(Q, 2, function(q)return(sqrt(sum(q^2))))
  return( (t(Q)%*%Q) / (mag_fron%*%t(mag_fron)) )
}
#knn
svd_knn <- function(NN, i, k){
  return(colnames(NN)[order(NN[,i], decreasing = T)[2:(1+k)]])
}
```

```{r}
#distance of items
NN = simi(result$q)
colnames(NN) = colnames(result$q)
rownames(NN) = colnames(result$q)
```

```{r}
#data for post regression (3-NN)
k = 3
reg_data = ratings[,1:3]
nn = apply(reg_data[2], 1, function(id)return(svd_knn( NN, as.character(id), k)))
```

```{r}
#3NN
reg_data <- cbind(reg_data, t(nn))
head(reg_data)
```

```{r}
pred_rating <- t(result$p)%*%result$q
rownames(pred_rating) = colnames(result$p)
colnames(pred_rating) = colnames(result$q)
x = c()
x_knn = c()
for (i in 1:dim(reg_data)[1]){
  x = c(x, pred_rating[as.character(reg_data[i,1]), as.character(reg_data[i,2])])
  x_knn = rbind(x_knn, 
                pred_rating[as.character(reg_data[i,1]), 
                            as.character(t(reg_data[i,4:(3+k)]))]
                )
}
colnames(x_knn) = paste('x', 1:k, sep = '')
```

```{r}
final_reg_data = as.data.frame(cbind(r = reg_data$rating, x, x_knn))
head(final_reg_data)
```

```{r}
model_knn = lm(r~x, data=final_reg_data)
mean((predict(model_knn) - ratings$rating)^2)
model_knn = lm(r~x+x1, data=final_reg_data)
mean((predict(model_knn) - ratings$rating)^2)
model_knn = lm(r~., data=final_reg_data)
mean((predict(model_knn) - ratings$rating)^2)
```


























